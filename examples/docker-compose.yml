# Lidify All-in-One Docker Compose
# Single container with embedded PostgreSQL, Redis, and audio analyzer
#
# Usage:
#   1. Copy to your compose folder
#   2. Edit paths below (/path/to/...)
#   3. Run: docker compose up -d

services:
  lidify:
    image: ghcr.io/fjordnode/lidify:latest
    # Or build from source:
    # build: https://github.com/fjordnode/lidify.git
    container_name: lidify
    restart: unless-stopped
    ports:
      - "3030:3030"   # Web UI
      - "3006:3006"   # API (optional, for external access)
    volumes:
      # Music library (read-only)
      - /path/to/your/music:/music:ro
      # Persistent data (database, cache, logs)
      - /path/to/appdata/lidify:/data:rw
    environment:
      - TZ=America/New_York  # Your timezone
      # Optional: AI-powered recommendations (get key at https://openrouter.ai)
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      # Optional: Last.fm integration (get key at https://www.last.fm/api)
      - LASTFM_API_KEY=${LASTFM_API_KEY:-}
      # --- ML Audio Analysis options ---
      # Number of parallel analysis workers (default: 2, increase if you have CPU headroom)
      - NUM_WORKERS=2
      # Disable ML analysis entirely (saves CPU, loses mood-based playlists)
      # - DISABLE_ML_ANALYSIS=true
      # Skip files larger than this (MB) to prevent timeouts on hi-res audio
      # - MAX_FILE_SIZE_MB=100
    extra_hosts:
      # Allows container to reach host services (e.g., Lidarr on host)
      - "host.docker.internal:host-gateway"

    # --- Traefik reverse proxy labels (optional) ---
    # Uncomment if using Traefik for HTTPS
    # networks:
    #   - traefik
    # labels:
    #   - traefik.enable=true
    #   - traefik.http.routers.lidify.entrypoints=websecure
    #   - traefik.http.routers.lidify.tls.certresolver=letsencrypt
    #   - traefik.http.routers.lidify.rule=Host(`lidify.yourdomain.com`)
    #   - traefik.http.services.lidify.loadbalancer.server.port=3030

# Uncomment if using Traefik
# networks:
#   traefik:
#     external: true
